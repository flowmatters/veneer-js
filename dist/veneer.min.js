"use strict";"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(n){return-1!==this.indexOf(n,this.length-n.length)}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(n){return 0===this.indexOf(n)});var arrayFunctions={};arrayFunctions.min=function(n){return Math.min.apply(null,n)},arrayFunctions.max=function(n){return Math.max.apply(null,n)},arrayFunctions.mean=function(n){return n.length?arrayFunctions.sum(n)/n.length:Number.NaN},arrayFunctions.sum=function(n){return n.reduce(function(n,r){return n+r},0)};var tsFunctions={};tsFunctions.toArray=function(n){return n.Events?n.Events.map(function(n){return n.Value}):n.length?n.map(function(n){return n.Value}):[]},tsFunctions.min=function(n){return n.Min?n.Min:arrayFunctions.min(tsFunctions.toArray(n))},tsFunctions.max=function(n){return n.Max?n.Max:arrayFunctions.max(tsFunctions.toArray(n))},tsFunctions.mean=function(n){return n.Mean?n.Mean:arrayFunctions.mean(tsFunctions.toArray(n))},tsFunctions.sum=function(n){return arrayFunctions.sum(tsFunctions.toArray(n))};var v;!function(){v={},v.prefix="",v.suffix={json:"",csv:""},v.img_suffix="",v.data_url=function(n,r){return v.prefix+n+v.suffix[r||"json"]},v.img_url=function(n){return v.prefix+n+v.img_suffix},v.tabulate_functions=function(n,r,t,e){var i=[];return n.forEach(function(n){var o=n.Name.match(r);if(null!==o){var u,a=o[t],f=o[e],c=i.filter(function(n){return n.index===a});0===c.length?(u={index:a},i.push(u)):u=c[0],u[f]=parseFloat(n.Expression)}}),i},v.categorise_functions=function(n,r,t){var e=[];return n.forEach(function(n){var i=n.Name.match(r);if(null!==i){var o={};for(var u in t)o[u]=i[t[u]];o.value=parseFloat(n.Expression),e.push(o)}}),e},v.group_by=function(n,r,t){var e=r.split("."),i=e[e.length-1],o=function(n,r){return void 0===r&&(r=e.slice()),1===r.length?n[r[0]]:o(n[r[0]],r.slice(1))};t=t||function(n){return n};var u=[];n.forEach(function(n){var r,t=o(n),e=u.filter(function(n){return n[i]===t});0===e.length?(r={},r[i]=t,r.values=[],u.push(r)):r=e[0],r.values.push(n)});for(var a in u){var f=u[a];f.value=t(f.values)}return u},v.outerJoin=function(n,r,t,e,i,o){function u(n){var r,t={};for(r in n)i?(o?!i[r]:i[r])&&(t[r]=1):t[r]=1;return t}function a(n){var r="."+n[s],t={};f[r]||(f[r]=t,f[c++]=t),t=f[r];for(var e in u(n))t[e]=n[e]}var f=[],c=0;i&&i.map(function(n){i[n]=1});var s=t;return n.map(a),s=e,r.map(a),f},v.innerJoin=function(n,r,t,e,i){var o=n.length,u=r.length,a=[],f=[];i||(i=function(n,r){var t={};for(var e in n)t[e]=n[e];for(e in r)t[e]=r[e];return t});for(var c=0;o>c;c++){var s=n[c];a[s[t]]=s}for(var v=0;u>v;v++){var l=r[v],p=a[l[e]];p&&f.push(i(p,l))}return f},v.lookupFirst=function(n,r,t){for(var e in n)if(n[e][r]===t)return n[e];return void 0},v.sum_field=function(n){var r=function(r){var t=0;return r.forEach(function(r){t+=r[n]}),t};return r},v.roundTo=function(n,r){var t=Math.pow(10,r);return Math.round(t*n)/t},v.features_of_type=function(n,r){var t=n.features.filter(function(n){return n.properties.feature_type===r});return{type:"FeatureCollection",features:t}},v.catchments_from_network=function(n){return v.features_of_type(n,"catchment")},v.links_from_network=function(n){return v.features_of_type(n,"link")},v.nodes_from_network=function(n){return v.features_of_type(n,"node")},v.match_links_to_catchments=function(n,r){var t=[];return r.features.forEach(function(r){t.push({catchment:r,link:n.features.filter(function(n){return n.id===r.properties.link})[0]})}),t},v.partition_network=function(n,r,t,e){var i=[],o=r.map(function(n){return n.link}),u=n.features.filter(function(n){return n.properties.name.startsWith(t)}),a=o.filter(function(n){return n.properties.name.startsWith(t)}),f=u.map(function(n){return{node:n}}).concat(a.map(function(n){return{link:n}})),c=0,s=function(r){return n.features.filter(function(n){return n.id===r.properties.from_node})[0]};return f.forEach(function(o){var u={node:o.node,links:[],catchments:[]},a=(o.node||o.link).properties.name.replace(t,"");if(e(u,a),u.index=c,o.link){var f=r.filter(function(n){return n.link===o.link})[0].catchment;e(o.link.properties,a),e(f.properties,a),u.links.push(o.link),u.catchments.push(f)}for(var v=[o.node||s(o.link)];v.length>0;){var l=v.pop(),p=r.filter(function(n){return n.link.properties.to_node===l.id});p.forEach(function(r){r.link.properties.name.startsWith(t)||(e(r.link.properties,a),e(r.catchment.properties,a),u.links.push(r.link),u.catchments.push(r.catchment),n.features.filter(function(n){return n.id===r.link.properties.from_node}).forEach(function(n){n.properties.name.startsWith(t)||v.push(n)}))})}i.push(u),c++}),i};var n=function(n){var r={};return n.date?r.date=n.date:r.Date=n.Date,r};v.binOp=function(r,t,e){var i=[],o=!1;t.length&&(v.assert(r.length===t.length),o=!0);for(var u in r){var a=r[u],f=o?t[u]:t;v.assert(!o||(a.date||a.Date).getTime()===(f.date||f.Date).getTime());var c=n(a);for(var s in a)"date"!==s&&"Date"!==s&&(c[s]=e(a[s],o?f[s]:f));i.push(c)}return i},v.subtract=function(n,r){return v.binOp(n,r,function(n,r){return n-r})},v.plus=function(n,r){return v.binOp(n,r,function(n,r){return n+r})},v.divide=function(n,r){return v.binOp(n,r,function(n,r){return n/r})},v.array=arrayFunctions,v.ts=tsFunctions,v.concentration=function(n){var r=[];for(var t in n){var e=n[t],i={};i.date=e.date;for(var o in e)"date"!==o&&"Flow"!==o&&(i[o]=e[o]/e.Flow);r.push(i)}return r},v.scale=function(n,r,t){var e=[];for(var i in n){var o=n[i],u={};["date","Date"].forEach(function(n){o[n]&&(u[n]=o[n])});for(var a in o)if("date"!==a.toLowerCase()){var f=t&&t[a]?t[a]:a;u[f]=o[a]*(r[a]||r.default||r)}e.push(u)}return e},v.rolling=function(n,r){var t=[],e={},i=0;for(var o in n){var u=n[o],a={};["date","Date"].forEach(function(n){u[n]&&(a[n]=u[n])});var f;if(r>=i){for(f in u)"date"!==f.toLowerCase()&&(e[f]=(e[f]||0)+u[f]);i++}if(i>r){for(f in u)"date"!==f.toLowerCase()&&(e[f]-=n[o-r][f]);i--}for(f in u)"date"!==f.toLowerCase()&&(a[f]=e[f]/i);t.push(a)}return t},v.numberOrder=function(n,r){return n-r},v.slice=function(n,r,t){var e=+r;return n.filter(function(n){return+n.Date>=e}).slice(0,t)},v.deciles_from_array=function(n,r){var t={};n.sort(v.numberOrder);for(var e in r){var i=r[e],o=i*n.length;t[i]=Math.floor(o)===o?(n[o-1]+n[o])/2:n[Math.floor(o)]}return t},v.deciles=function(n,r){var t={};for(var e in n[0])"date"!==e&&"Date"!==e&&(t[e]=[]);for(var i in n)for(e in t)t[e].push(n[i][e]);var o={};for(e in t)o[e]=v.deciles_from_array(t[e],r);return o},v.assert=function(n){console&&console.assert(n)},v.configureRecorders=function(n,r){var t=function(n){return"location/"+n.NetworkElement+"/element/"+n.RecordingElement+"/variable/"+(n.RecordingVariable||n.RecordingElement)};return{RecordNone:r?r.map(t):[],RecordAll:n.map(t)}}}();