"use strict";"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(n){return-1!==this.indexOf(n,this.length-n.length)}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(n){return 0===this.indexOf(n)});var arrayFunctions={};arrayFunctions.min=function(n){return Math.min.apply(null,n)},arrayFunctions.max=function(n){return Math.max.apply(null,n)},arrayFunctions.mean=function(n){return n.length?arrayFunctions.sum(n)/n.length:Number.NaN},arrayFunctions.sum=function(n){return n.reduce(function(n,t){return n+t},0)};var tsFunctions={};tsFunctions.toArray=function(n){return n.Events?n.Events.map(function(n){return n.Value}):n.length?n.map(function(n){return n.Value}):[]},tsFunctions.min=function(n){return n.Min?n.Min:arrayFunctions.min(tsFunctions.toArray(n))},tsFunctions.max=function(n){return n.Max?n.Max:arrayFunctions.max(tsFunctions.toArray(n))},tsFunctions.mean=function(n){return n.Mean?n.Mean:arrayFunctions.mean(tsFunctions.toArray(n))},tsFunctions.sum=function(n){return arrayFunctions.sum(tsFunctions.toArray(n))},tsFunctions.extractPeriod=function(n,t,r){return{Events:n.Events.filter(function(n){return n.Date>=t&&n.Date<=r})}},tsFunctions.extractYear=function(n,t){return{Events:n.Events.filter(function(n){return n.Date.getFullYear()===t})}},tsFunctions.extractMonthAndYear=function(n,t,r){return{Events:n.Events.filter(function(n){return n.Date.getFullYear()===r&&n.Date.getMonth()===t})}},tsFunctions.sumForPeriod=function(n,t,r){return tsFunctions.sum(tsFunctions.extractPeriod(n,t,r))},tsFunctions.sumForYear=function(n,t){return tsFunctions.sum(tsFunctions.extractYear(n,t))},tsFunctions.sumForMonthAndYear=function(n,t,r){return tsFunctions.sum(tsFunctions.extractMonthAndYear(n,t,r))};var v;!function(){v={},v.prefix="",v.suffix={json:"",csv:""},v.img_suffix="",v.data_url=function(n,t){return v.prefix+n+v.suffix[t||"json"]},v.img_url=function(n){return v.prefix+n+v.img_suffix},v.docUrl=function(n){return v.prefix+n},v.tabulate_functions=function(n,t,r,e){var i=[];return n.forEach(function(n){var o=n.Name.match(t);if(null!==o){var u,a=o[r],c=o[e],s=i.filter(function(n){return n.index===a});0===s.length?(u={index:a},i.push(u)):u=s[0],u[c]=parseFloat(n.Expression)}}),i},v.categorise_functions=function(n,t,r){var e=[];return n.forEach(function(n){var i=n.Name.match(t);if(null!==i){var o={};for(var u in r)o[u]=i[r[u]];o.value=parseFloat(n.Expression),e.push(o)}}),e},v.group_by=function(n,t,r){var e=t.split("."),i=e[e.length-1],o=function(n,t){return void 0===t&&(t=e.slice()),1===t.length?n[t[0]]:o(n[t[0]],t.slice(1))};r=r||function(n){return n};var u=[];n.forEach(function(n){var t,r=o(n),e=u.filter(function(n){return n[i]===r});0===e.length?(t={},t[i]=r,t.values=[],u.push(t)):t=e[0],t.values.push(n)});for(var a in u){var c=u[a];c.value=r(c.values)}return u},v.outerJoin=function(n,t,r,e,i,o){function u(n){var t,r={};for(t in n)i?(o?!i[t]:i[t])&&(r[t]=1):r[t]=1;return r}function a(n){var t="."+n[f],r={};c[t]||(c[t]=r,c[s++]=r),r=c[t];for(var e in u(n))r[e]=n[e]}var c=[],s=0;i&&i.map(function(n){i[n]=1});var f=r;return n.map(a),f=e,t.map(a),c},v.innerJoin=function(n,t,r,e,i){var o=n.length,u=t.length,a=[],c=[];i||(i=function(n,t){var r={};for(var e in n)r[e]=n[e];for(e in t)r[e]=t[e];return r});for(var s=0;o>s;s++){var f=n[s];a[f[r]]=f}for(var v=0;u>v;v++){var l=t[v],p=a[l[e]];p&&c.push(i(p,l))}return c},v.lookupFirst=function(n,t,r){for(var e in n)if(n[e][t]===r)return n[e];return void 0},v.sum_field=function(n){var t=function(t){var r=0;return t.forEach(function(t){r+=t[n]}),r};return t},v.roundTo=function(n,t){var r=Math.pow(10,t);return Math.round(r*n)/r},v.features_of_type=function(n,t){var r=n.features.filter(function(n){return n.properties.feature_type===t});return{type:"FeatureCollection",features:r}},v.catchments_from_network=function(n){return v.features_of_type(n,"catchment")},v.links_from_network=function(n){return v.features_of_type(n,"link")},v.nodes_from_network=function(n){return v.features_of_type(n,"node")},v.match_links_to_catchments=function(n,t){var r=[];return t.features.forEach(function(t){r.push({catchment:t,link:n.features.filter(function(n){return n.id===t.properties.link})[0]})}),r},v.partition_network=function(n,t,r,e){var i=[],o=t.map(function(n){return n.link}),u=n.features.filter(function(n){return n.properties.name.startsWith(r)}),a=o.filter(function(n){return n.properties.name.startsWith(r)}),c=u.map(function(n){return{node:n}}).concat(a.map(function(n){return{link:n}})),s=0,f=function(t){return n.features.filter(function(n){return n.id===t.properties.from_node})[0]};return c.forEach(function(o){var u={node:o.node,links:[],catchments:[]},a=(o.node||o.link).properties.name.replace(r,"");if(e(u,a),u.index=s,o.link){var c=t.filter(function(n){return n.link===o.link})[0].catchment;e(o.link.properties,a),e(c.properties,a),u.links.push(o.link),u.catchments.push(c)}for(var v=[o.node||f(o.link)];v.length>0;){var l=v.pop(),p=t.filter(function(n){return n.link.properties.to_node===l.id});p.forEach(function(t){t.link.properties.name.startsWith(r)||(e(t.link.properties,a),e(t.catchment.properties,a),u.links.push(t.link),u.catchments.push(t.catchment),n.features.filter(function(n){return n.id===t.link.properties.from_node}).forEach(function(n){n.properties.name.startsWith(r)||v.push(n)}))})}i.push(u),s++}),i};var n=function(n){var t={};return n.date?t.date=n.date:t.Date=n.Date,t};v.binOp=function(t,r,e){var i=[],o=!1;r.length&&(v.assert(t.length===r.length),o=!0);for(var u in t){var a=t[u],c=o?r[u]:r;v.assert(!o||(a.date||a.Date).getTime()===(c.date||c.Date).getTime());var s=n(a);for(var f in a)"date"!==f&&"Date"!==f&&(s[f]=e(a[f],o?c[f]:c));i.push(s)}return i},v.subtract=function(n,t){return v.binOp(n,t,function(n,t){return n-t})},v.plus=function(n,t){return v.binOp(n,t,function(n,t){return n+t})},v.divide=function(n,t){return v.binOp(n,t,function(n,t){return n/t})},v.array=arrayFunctions,v.ts=tsFunctions,v.concentration=function(n){var t=[];for(var r in n){var e=n[r],i={};i.date=e.date;for(var o in e)"date"!==o&&"Flow"!==o&&(i[o]=e[o]/e.Flow);t.push(i)}return t},v.scale=function(n,t,r){var e=[];for(var i in n){var o=n[i],u={};["date","Date"].forEach(function(n){o[n]&&(u[n]=o[n])});for(var a in o)if("date"!==a.toLowerCase()){var c=r&&r[a]?r[a]:a;u[c]=o[a]*(t[a]||t.default||t)}e.push(u)}return e},v.rolling=function(n,t){var r=[],e={},i=0;for(var o in n){var u=n[o],a={};["date","Date"].forEach(function(n){u[n]&&(a[n]=u[n])});var c;if(t>=i){for(c in u)"date"!==c.toLowerCase()&&(e[c]=(e[c]||0)+u[c]);i++}if(i>t){for(c in u)"date"!==c.toLowerCase()&&(e[c]-=n[o-t][c]);i--}for(c in u)"date"!==c.toLowerCase()&&(a[c]=e[c]/i);r.push(a)}return r},v.numberOrder=function(n,t){return n-t},v.slice=function(n,t,r){var e=+t;return n.filter(function(n){return+n.Date>=e}).slice(0,r)},v.deciles_from_array=function(n,t){var r={};n.sort(v.numberOrder);for(var e in t){var i=t[e],o=i*n.length;r[i]=Math.floor(o)===o?(n[o-1]+n[o])/2:n[Math.floor(o)]}return r},v.deciles=function(n,t){var r={};for(var e in n[0])"date"!==e&&"Date"!==e&&(r[e]=[]);for(var i in n)for(e in r)r[e].push(n[i][e]);var o={};for(e in r)o[e]=v.deciles_from_array(r[e],t);return o},v.assert=function(n){console&&console.assert(n)},v.configureRecorders=function(n,t){var r=function(n){return"location/"+n.NetworkElement+"/element/"+n.RecordingElement+"/variable/"+(n.RecordingVariable||n.RecordingElement)};return{RecordNone:t?t.map(r):[],RecordAll:n.map(r)}}}();