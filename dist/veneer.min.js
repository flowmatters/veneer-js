"use strict";function intersection_destructive(n,t){for(var r=[];n.length>0&&t.length>0;)n[0]<t[0]?n.shift():n[0]>t[0]?t.shift():(r.push(n.shift()),t.shift());return r}"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(n){return-1!==this.indexOf(n,this.length-n.length)}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(n){return 0===this.indexOf(n)});var v,arrayFunctions={};arrayFunctions.min=function(n){return Math.min.apply(null,n)},arrayFunctions.max=function(n){return Math.max.apply(null,n)},arrayFunctions.mean=function(n){return n.length?arrayFunctions.sum(n)/n.length:Number.NaN},arrayFunctions.sum=function(n){return n.reduce(function(n,t){return n+t},0)};var tsFunctions={};tsFunctions.toArray=function(n){return n.Events?n.Events.map(function(n){return n.Value}):n.length?n.map(function(n){return n.Value}):[]},tsFunctions.min=function(n){return n.Min?n.Min:arrayFunctions.min(tsFunctions.toArray(n))},tsFunctions.max=function(n){return n.Max?n.Max:arrayFunctions.max(tsFunctions.toArray(n))},tsFunctions.mean=function(n){return n.Mean?n.Mean:arrayFunctions.mean(tsFunctions.toArray(n))},tsFunctions.sum=function(n){return arrayFunctions.sum(tsFunctions.toArray(n))},tsFunctions.extractPeriod=function(n,t,r){return{Events:n.Events.filter(function(n){return n.Date>=t&&n.Date<=r})}},tsFunctions.extractYear=function(n,t){return{Events:n.Events.filter(function(n){return n.Date.getFullYear()===t})}},tsFunctions.extractMonthAndYear=function(n,t,r){return{Events:n.Events.filter(function(n){return n.Date.getFullYear()===r&&n.Date.getMonth()===t})}},tsFunctions._events=function(n){return n.Events||n},tsFunctions.intersect=function(n,t){var r=[{Events:[]},{Events:[]}],e=function(n){return n.Date},u=function(n){return tsFunctions._events(n).map(e)},i=intersection_destructive(u(n),u(t)),o=-1,a=-1,s=function(n,t,r){for(var e=tsFunctions._events(n),u=r+1;u<e.length;u++)if(e[u].Date.getTime()===t.getTime())return u;return null};return i.forEach(function(e){o=s(n,e,o),r[0].Events.push({Date:e,Value:tsFunctions._events(n)[o].Value}),a=s(t,e,a),r[1].Events.push({Date:e,Value:tsFunctions._events(t)[a].Value})}),r},tsFunctions.sumForPeriod=function(n,t,r){return tsFunctions.sum(tsFunctions.extractPeriod(n,t,r))},tsFunctions.sumForYear=function(n,t){return tsFunctions.sum(tsFunctions.extractYear(n,t))},tsFunctions.sumForMonthAndYear=function(n,t,r){return tsFunctions.sum(tsFunctions.extractMonthAndYear(n,t,r))},tsFunctions.cumulativeSum=function(n){var t=void 0!==n.Events,r=n.Events||n,e=0,u=r.map(function(n){return e+=n.Value,{Date:n.Date,Value:e}});return t?{Events:u}:u},tsFunctions.NSE=function(n,t){var r=tsFunctions.intersect(n,t),e=r[0],u=r[1],i=v.subtract(u,e),o=tsFunctions.sum(v.multiply(i,i)),a=v.subtract(u,tsFunctions.mean(u)),s=tsFunctions.sum(v.multiply(a,a));return 1-o/s},tsFunctions.NSE.bivariate=!0,function(){v={},v.prefix="",v.suffix={json:"",csv:""},v.img_suffix="",v.data_url=function(n,t){return v.prefix+n+v.suffix[t||"json"]},v.img_url=function(n){return v.prefix+n+v.img_suffix},v.docUrl=function(n){return v.prefix+n},v.tabulate_functions=function(n,t,r,e){var u=[];return n.forEach(function(n){var i=n.Name.match(t);if(null!==i){var o,a=i[r],s=i[e],c=u.filter(function(n){return n.index===a});0===c.length?(o={index:a},u.push(o)):o=c[0],o[s]=parseFloat(n.Expression)}}),u},v.categorise_functions=function(n,t,r){var e=[];return n.forEach(function(n){var u=n.Name.match(t);if(null!==u){var i={};for(var o in r)i[o]=u[r[o]];i.value=parseFloat(n.Expression),e.push(i)}}),e},v.group_by=function(n,t,r){var e=t.split("."),u=e[e.length-1],i=function(n,t){return void 0===t&&(t=e.slice()),1===t.length?n[t[0]]:i(n[t[0]],t.slice(1))};r=r||function(n){return n};var o=[];n.forEach(function(n){var t,r=i(n),e=o.filter(function(n){return n[u]===r});0===e.length?(t={},t[u]=r,t.values=[],o.push(t)):t=e[0],t.values.push(n)});for(var a in o){var s=o[a];s.value=r(s.values)}return o},v.outerJoin=function(n,t,r,e,u,i){function o(n){var t,r={};for(t in n)u?(i?!u[t]:u[t])&&(r[t]=1):r[t]=1;return r}function a(n){var t="."+n[f],r={};s[t]||(s[t]=r,s[c++]=r),r=s[t];for(var e in o(n))r[e]=n[e]}var s=[],c=0;u&&u.map(function(n){u[n]=1});var f=r;return n.map(a),f=e,t.map(a),s},v.innerJoin=function(n,t,r,e,u){var i=n.length,o=t.length,a=[],s=[];u||(u=function(n,t){var r={};for(var e in n)r[e]=n[e];for(e in t)r[e]=t[e];return r});for(var c=0;i>c;c++){var f=n[c];a[f[r]]=f}for(var v=0;o>v;v++){var l=t[v],p=a[l[e]];p&&s.push(u(p,l))}return s},v.lookupFirst=function(n,t,r){for(var e in n)if(n[e][t]===r)return n[e];return void 0},v.sum_field=function(n){var t=function(t){var r=0;return t.forEach(function(t){r+=t[n]}),r};return t},v.roundTo=function(n,t){var r=Math.pow(10,t);return Math.round(r*n)/r},v.features_of_type=function(n,t){var r=n.features.filter(function(n){return n.properties.feature_type===t});return{type:"FeatureCollection",features:r}},v.catchments_from_network=function(n){return v.features_of_type(n,"catchment")},v.links_from_network=function(n){return v.features_of_type(n,"link")},v.nodes_from_network=function(n){return v.features_of_type(n,"node")},v.match_links_to_catchments=function(n,t){var r=[];return t.features.forEach(function(t){r.push({catchment:t,link:n.features.filter(function(n){return n.id===t.properties.link})[0]})}),r},v.partition_network=function(n,t,r,e){var u=[],i=t.map(function(n){return n.link}),o=n.features.filter(function(n){return n.properties.name.startsWith(r)}),a=i.filter(function(n){return n.properties.name.startsWith(r)}),s=o.map(function(n){return{node:n}}).concat(a.map(function(n){return{link:n}})),c=0,f=function(t){return n.features.filter(function(n){return n.id===t.properties.from_node})[0]};return s.forEach(function(i){var o={node:i.node,links:[],catchments:[]},a=(i.node||i.link).properties.name.replace(r,"");if(e(o,a),o.index=c,i.link){var s=t.filter(function(n){return n.link===i.link})[0].catchment;e(i.link.properties,a),e(s.properties,a),o.links.push(i.link),o.catchments.push(s)}for(var v=[i.node||f(i.link)];v.length>0;){var l=v.pop(),p=t.filter(function(n){return n.link.properties.to_node===l.id});p.forEach(function(t){t.link.properties.name.startsWith(r)||(e(t.link.properties,a),e(t.catchment.properties,a),o.links.push(t.link),o.catchments.push(t.catchment),n.features.filter(function(n){return n.id===t.link.properties.from_node}).forEach(function(n){n.properties.name.startsWith(r)||v.push(n)}))})}u.push(o),c++}),u};var n=function(n){var t={};return n.date?t.date=n.date:t.Date=n.Date,t};v.binOp=function(t,r,e){t=tsFunctions._events(t),r=tsFunctions._events(r);var u=[],i=!1;r.length&&(v.assert(t.length===r.length),i=!0);for(var o in t){var a=t[o],s=i?r[o]:r;v.assert(!i||(a.date||a.Date).getTime()===(s.date||s.Date).getTime());var c=n(a);for(var f in a)"date"!==f&&"Date"!==f&&(c[f]=e(a[f],i?s[f]:s));u.push(c)}return u},v.subtract=function(n,t){return v.binOp(n,t,function(n,t){return n-t})},v.plus=function(n,t){return v.binOp(n,t,function(n,t){return n+t})},v.multiply=function(n,t){return v.binOp(n,t,function(n,t){return n*t})},v.divide=function(n,t){return v.binOp(n,t,function(n,t){return n/t})},v.array=arrayFunctions,v.ts=tsFunctions,v.concentration=function(n){var t=[];for(var r in n){var e=n[r],u={};u.date=e.date;for(var i in e)"date"!==i&&"Flow"!==i&&(u[i]=e[i]/e.Flow);t.push(u)}return t},v.scale=function(n,t,r){var e=[];for(var u in n){var i=n[u],o={};["date","Date"].forEach(function(n){i[n]&&(o[n]=i[n])});for(var a in i)if("date"!==a.toLowerCase()){var s=r&&r[a]?r[a]:a;o[s]=i[a]*(t[a]||t.default||t)}e.push(o)}return e},v.rolling=function(n,t){var r=[],e={},u=0;for(var i in n){var o=n[i],a={};["date","Date"].forEach(function(n){o[n]&&(a[n]=o[n])});var s;if(t>=u){for(s in o)"date"!==s.toLowerCase()&&(e[s]=(e[s]||0)+o[s]);u++}if(u>t){for(s in o)"date"!==s.toLowerCase()&&(e[s]-=n[i-t][s]);u--}for(s in o)"date"!==s.toLowerCase()&&(a[s]=e[s]/u);r.push(a)}return r},v.numberOrder=function(n,t){return n-t},v.slice=function(n,t,r){var e=+t;return n.filter(function(n){return+n.Date>=e}).slice(0,r)},v.deciles_from_array=function(n,t){var r={};n.sort(v.numberOrder);for(var e in t){var u=t[e],i=u*n.length;r[u]=Math.floor(i)===i?(n[i-1]+n[i])/2:n[Math.floor(i)]}return r},v.deciles=function(n,t){var r={};for(var e in n[0])"date"!==e&&"Date"!==e&&(r[e]=[]);for(var u in n)for(e in r)r[e].push(n[u][e]);var i={};for(e in r)i[e]=v.deciles_from_array(r[e],t);return i},v.assert=function(n){console&&console.assert(n)},v.configureRecorders=function(n,t){var r=function(n){return"location/"+n.NetworkElement+"/element/"+n.RecordingElement+"/variable/"+(n.RecordingVariable||n.RecordingElement)};return{RecordNone:t?t.map(r):[],RecordAll:n.map(r)}}}();