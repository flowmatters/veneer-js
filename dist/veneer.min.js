"use strict";"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(r){return-1!==this.indexOf(r,this.length-r.length)}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(r){return 0===this.indexOf(r)});var v;!function(){v={},v.prefix="",v.suffix="",v.img_suffix="",v.data_url=function(r){return v.prefix+r+v.suffix},v.img_url=function(r){return v.prefix+r+v.img_suffix},v.tabulate_functions=function(r,n,t,e){var i=[];return r.forEach(function(r){var o=r.Name.match(n);if(null!==o){var a,u=o[t],f=o[e],c=i.filter(function(r){return r.index===u});0===c.length?(a={index:u},i.push(a)):a=c[0],a[f]=parseFloat(r.Expression)}}),i},v.categorise_functions=function(r,n,t){var e=[];return r.forEach(function(r){var i=r.Name.match(n);if(null!==i){var o={};for(var a in t)o[a]=i[t[a]];o.value=parseFloat(r.Expression),e.push(o)}}),e},v.group_by=function(r,n,t){var e=[];r.forEach(function(r){var t,i=r[n],o=e.filter(function(r){return r[n]===i});0===o.length?(t={},t[n]=i,t.values=[],e.push(t)):t=o[0],t.values.push(r)});for(var i in e){var o=e[i];o.value=t(o.values)}return e},v.outerJoin=function(r,n,t,e,i,o){function a(r){var n,t={};for(n in r)i?(o?!i[n]:i[n])&&(t[n]=1):t[n]=1;return t}function u(r){var n="."+r[s],t={};f[n]||(f[n]=t,f[c++]=t),t=f[n];for(var e in a(r))t[e]=r[e]}var f=[],c=0;i&&i.map(function(r){i[r]=1});var s=t;return r.map(u),s=e,n.map(u),f},v.innerJoin=function(r,n,t,e,i){var o=r.length,a=n.length,u=[],f=[];i||(i=function(r,n){var t={};for(var e in r)t[e]=r[e];for(e in n)t[e]=n[e];return t});for(var c=0;o>c;c++){var s=r[c];u[s[t]]=s}for(var v=0;a>v;v++){var l=n[v],p=u[l[e]];p&&f.push(i(p,l))}return f},v.lookupFirst=function(r,n,t){for(var e in r)if(r[e][n]===t)return r[e];return void 0},v.sum_field=function(r){var n=function(n){var t=0;return n.forEach(function(n){t+=n[r]}),t};return n},v.roundTo=function(r,n){var t=Math.pow(10,n);return Math.round(t*r)/t},v.features_of_type=function(r,n){var t=r.features.filter(function(r){return r.properties.feature_type===n});return{type:"FeatureCollection",features:t}},v.catchments_from_network=function(r){return v.features_of_type(r,"catchment")},v.links_from_network=function(r){return v.features_of_type(r,"link")},v.nodes_from_network=function(r){return v.features_of_type(r,"node")},v.match_links_to_catchments=function(r,n){var t=[];return n.features.forEach(function(n){t.push({catchment:n,link:r.features.filter(function(r){return r.id===n.properties.link})[0]})}),t},v.partition_network=function(r,n,t,e){var i=[],o=n.map(function(r){return r.link}),a=r.features.filter(function(r){return r.properties.name.startsWith(t)}),u=o.filter(function(r){return r.properties.name.startsWith(t)}),f=a.map(function(r){return{node:r}}).concat(u.map(function(r){return{link:r}})),c=0,s=function(n){return r.features.filter(function(r){return r.id===n.properties.from_node})[0]};return f.forEach(function(o){var a={node:o.node,links:[],catchments:[]},u=(o.node||o.link).properties.name.replace(t,"");if(e(a,u),a.index=c,o.link){var f=n.filter(function(r){return r.link===o.link})[0].catchment;e(o.link.properties,u),e(f.properties,u),a.links.push(o.link),a.catchments.push(f)}for(var v=[o.node||s(o.link)];v.length>0;){var l=v.pop(),p=n.filter(function(r){return r.link.properties.to_node===l.id});p.forEach(function(n){n.link.properties.name.startsWith(t)||(e(n.link.properties,u),e(n.catchment.properties,u),a.links.push(n.link),a.catchments.push(n.catchment),r.features.filter(function(r){return r.id===n.link.properties.from_node}).forEach(function(r){r.properties.name.startsWith(t)||v.push(r)}))})}i.push(a),c++}),i},v.subtract=function(r,n){var t=[],e=!1;n.length&&(v.assert(r.length===n.length),e=!0);for(var i in r){var o=r[i],a=e?n[i]:n,u={};v.assert(!e||o.date.getTime()===a.date.getTime()),u.date=o.date;for(var f in o)"date"!==f&&(u[f]=o[f]-(e?a[f]:a));t.push(u)}return t},v.plus=function(r,n){var t=[];v.assert(r.length===n.length);for(var e in r){var i=r[e],o=n[e],a={};v.assert(i.date.getTime()===o.date.getTime()),a.date=i.date;for(var u in i)"date"!==u&&(a[u]=i[u]+o[u]);t.push(a)}return t},v.concentration=function(r){var n=[];for(var t in r){var e=r[t],i={};i.date=e.date;for(var o in e)"date"!==o&&"Flow"!==o&&(i[o]=e[o]/e.Flow);n.push(i)}return n},v.scale=function(r,n,t){var e=[];for(var i in r){var o=r[i],a={};["date","Date"].forEach(function(r){o[r]&&(a[r]=o[r])});for(var u in o)if("date"!==u.toLowerCase()){var f=t&&t[u]?t[u]:u;a[f]=o[u]*(n[u]||n.default||n)}e.push(a)}return e},v.rolling=function(r,n){var t=[],e={},i=0;for(var o in r){var a=r[o],u={};["date","Date"].forEach(function(r){a[r]&&(u[r]=a[r])});var f;if(n>=i){for(f in a)"date"!==f.toLowerCase()&&(e[f]=(e[f]||0)+a[f]);i++}if(i>n){for(f in a)"date"!==f.toLowerCase()&&(e[f]-=r[o-n][f]);i--}for(f in a)"date"!==f.toLowerCase()&&(u[f]=e[f]/i);t.push(u)}return t},v.numberOrder=function(r,n){return r-n},v.slice=function(r,n,t){var e=+n;return r.filter(function(r){return+r.Date>=e}).slice(0,t)},v.deciles_from_array=function(r,n){var t={};r.sort(v.numberOrder);for(var e in n){var i=n[e],o=i*r.length;t[i]=Math.floor(o)===o?(r[o-1]+r[o])/2:r[Math.floor(o)]}return t},v.deciles=function(r,n){var t={};for(var e in r[0])"date"!==e&&(t[e]=[]);for(var i in r)for(e in t)t[e].push(r[i][e]);var o={};for(e in t)o[e]=v.deciles_from_array(t[e],n);return o},v.assert=function(r){console&&console.assert(r)},v.configureRecorders=function(r,n){var t=function(r){return"location/"+r.NetworkElement+"/element/"+r.RecordingElement+"/variable/"+(r.RecordingVariable||r.RecordingElement)};return{RecordNone:n?n.map(t):[],RecordAll:r.map(t)}}}();